<% include ../header.ejs %>

<!--支付管理--收银台配置-->
<div id="content">
	<div id="content-header">
		<div id="breadcrumb">
			<a href="#" class="tip-bottom"><i class="icon-home"></i>渠道管理</a>
			<a href="#" class="current">收银台配置</a>
		</div>
		<h1>收银台配置</h1>
	</div>
	<div class="container-fluid">
		<div class="loading">
			<img src="/images/jiazai.gif" alt="">
		</div>
		<hr>
		<div class="xiangqing_list" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(205, 205, 205);">
			<a href="/pay/PayAisle" target="liquidation" class="btn2 ">支付通道管理</a>

			<a href="/pay/checkstand" target="liquidation" class="btn2 cur1">收银台配置</a>
		
			<a href="/pay/product" target="liquidation" class="btn2">产品管理</a>			
		</div>
		<div class="row-fluid">
			<div class="widget-box">
				<div class="widget-content nopadding">
					<form class="form-horizontal" id="signupForm" method="post" action="">
						<table class="table table-striped">
							<tbody>
								<tr class="odd gradeX">
									<td width="100" style="white-space: nowrap;">
										产品名称 :</td>
									<td width="300" style="white-space: nowrap;">
										<select name="productLine" id="productLine" v-model="cp_id">
											<option value="">全部</option>
											<option v-for="pro in ProList" v-bind:value="pro.id" v-text="pro.productName"></option>
										</select>
									</td>
									<td>
										<button type="button" id="submit" class="btn btn-success"  @click="listenDate(1)">查找</button>
									</td>
									<td width="200"></td>
									<td width="200"></td>

								</tr>
							</tbody>
						</table>

						</td>
						</tr>
						</tbody>
						</table>
					</form>

				</div>
			</div>
		</div>

		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"style="display: none;">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								&times;
							</button>
						<h4 class="modal-title" id="myModalLabel">
								添加收银台
							</h4>
					</div>
					<div class="modal-body">
						<div class="container-fluid">
							<div class="row-fluid">
								<form id="addNewRule">
									<div class="widget-content nopadding form-horizontal">
										<input type="hidden" id="druleId" name="druleId">
										<div class="control-group">
											<label class="control-label" style="width: 150px">产品名称 :</label>
											<div class="controls">
												<select name="" id="" v-model="proName">
													<option value="">全部</option>
											<option v-for="pro in ProList" v-bind:value="pro.id" v-text="pro.productName"></option>
												</select>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" style="width: 150px">运行平台 :</label>
											<div class="controls">
												<select name="" id="" v-model="ptName">
													<option value="">全部</option>
											<option v-for="msg in ptList1" v-bind:value="msg.id" v-text="msg.name"></option>
										</select>
												</select>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" style="width: 150px">可选支付通道 :</label>
											<div class="controls">
												<label v-for="aa in kxzfList" style="display: inline-block;padding-right: 10px;">
													<input type="checkbox" v-model="checkedNames" class="input-checked" v-bind:value="aa.id"/>{{aa.name}}
												</label>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭
							</button>
						<button type="button" class="btn btn-primary" @click="addsyt">
								提交
							</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
<div class="modal fade" id="myModal-one" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"style="display: none;">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								&times;
							</button>
						<h4 class="modal-title" id="myModalLabel">
								修改收银台
							</h4>
					</div>
					<div class="modal-body">
						<div class="container-fluid">
							<div class="row-fluid">
								<form id="addNewRule">
									<div class="widget-content nopadding form-horizontal">
										<input type="hidden" id="druleId" name="druleId">
										<div class="control-group">
											<label class="control-label" style="width: 150px">产品名称 :</label>
											<div class="controls">
												<select name="" id="" v-model="proName_1" disabled="disabled">
													<option value="">全部</option>
											<option v-for="pro in ProList" v-bind:value="pro.id" v-text="pro.productName"></option>
												</select>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" style="width: 150px">运行平台 :</label>
											<div class="controls">
												<select name="" id="" v-model="ptName_1" disabled="disabled">
													<option value="">全部</option>
											        <option v-for="msg in ptList1" v-bind:value="msg.id" v-text="msg.name"></option>
										        </select>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" style="width: 150px">可选支付通道 :</label>
											<div class="controls">
												<label v-for="aa in kxzfList_1" style="display: inline-block;padding-right: 10px;">
													<input type="checkbox" v-model="checkedNames_1" class="input-checked" v-bind:value="aa.id"/>{{aa.name}}
												</label>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭
							</button>
						<button type="button" class="btn btn-primary" @click="upAdd(id_1)">
								提交更改
							</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
		<hr>
		<div class="row-fluid">
			<div class="span12">
				<div class="widget-box">
					<div class="widget-title"> <span class="icon"> <i class="icon-th"></i> </span>
						<h5>			<button type="button" id="submit" class="btn btn-primary position_right" data-toggle="modal" data-target="#myModal">添加收银台</button>
</h5>
					</div>
					<div class="widget-content nopadding" id="common_list">
						<table class="table table-bordered table-striped">
							<thead>
								<tr>
									<th>id</th>
									<th>产品名称</th>
									<th>运行品台</th>
									<th>支付通道</th>
									<th width="100" style="white-space: nowrap;">操作</th>
								</tr>
							</thead>
							<tbody class="table_toggle">
							    <tr v-for="msg in payList">
									<td v-text="msg.id"></td>
									<td v-text="msg.productName"></td>
									<td v-text="msg.platformName"></td>
									<td v-text="msg.channelName"></td>
									<td width="100" style="white-space: nowrap;">
										<button class="btn-info btn-mini float_btn_cen" data-toggle="modal" data-target="#myModal-one" @click="idUp(msg.id)">管理</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="table_toggle1" style="display: none;">暂无数据</div>

				</div>

			</div>
		</div>
		<div id="page">
		    <vue-nav :cur.sync="cur" :all.sync="all" v-on:btn-click="listenDate"></vue-nav>
		</div>
	</div>
</div>

<!--<div class="row-fluid">
  <div id="footer" class="span12"> 2013 &copy; Matrix Admin. More Templates <a href="http://www.mycodes.net/" target="_blank">源码之家</a></div>
</div>-->

<% include ../footer.ejs %>
<script src="/javascripts/public_page.js"></script>
<script src="/javascripts/vue-resource.js"></script>
<script type="text/javascript">
var total = "";
    var pageBar = new Vue({
        el: '#content',
        data: {
            all: 0, //总页数
            cur: 1,//当前页码
            msg:'',
            ProList:"",
            cp_id:"",
            payList:"",
            pageTotal:"",
            ptList1:"",
            proName:"",
            ptName:"",
            kxzfList:"",
            checkedNames:[],
    	    channelId_1:"",
    	    platformId_1:"",
    	    platformName_1:"",
    	    productId_1:"",
    	    productName_1:"",
    	    id_1:"",
    	    ptName_1:"",
    	    proName_1:"",
    	    checkedNames_1:[],
    	    kxzfList_1:"",
        },
        components:{
            'vue-nav':pagenav
        },
        watch: {
            cur: function(oldValue , newValue){
                // //console.log('监听cur前与后的值：');
                // //console.log(arguments);
            },
            proName:function(oldValue , newValue){
                 ////console.log(this.checkedNames);
                 this.checkedNames=[];
                if(this.proName && this.ptName!==""){
                   this.kxList(this.proName,this.ptName);
                }
            },
            ptName:function(oldValue , newValue){
            	this.checkedNames=[];
            	    if(this.proName && this.ptName!==""){
                   this.kxList(this.proName,this.ptName);
                }
            },
            proName_1:function(oldValue , newValue){
                if(this.proName_1 && this.ptName_1!==""){
                   this.kxList_1(this.proName_1,this.ptName_1);
                }
            },
            ptName_1:function(oldValue , newValue){
            	    if(this.proName_1 && this.ptName_1!==""){
                   this.kxList_1(this.proName_1,this.ptName_1);
                }
            },
        },
        mounted:function(){
			this.listenDate(this.cur);
			this.productList();
			this.ptList();
			// this.kxList(this.proName,this.ptName);
		},
        methods:{
        	//添加收银台
        	addsyt:function(){
				var _this = this;
				var proName = this.proName;
				var ptName = this.ptName;
				var checkedNames = this.checkedNames;
				 var platformId = checkedNames.join(",");
				if(proName==""){
					alert("请选择产品名称");
					return false;
				}else if(ptName==""){
					alert("请选择运行平台");
					return false;
				}else if(checkedNames.length==0){
					alert("请选择可选支付通道");
					return false;
				}else{
					var _this = this;
					this.$http.post("/pay/cashier/saveCas",{"productId":proName,"platformId":ptName,"channelId":platformId}).then(function(res){
						////console.log(res);
						var code=res.body.code;
						var msg = res.body.msg;
						if(code=="0000"){
							alert(msg)
							$("#myModal").modal("hide");
							_this.listenDate(this.cur);
							_this.proName="";
							_this.ptName="";
							_this.checkedNames="";
						}else if(code=="0001"){
                            alert(msg);
						}
					});

				}

		    },
            productList:function(){
            	var _this = this;
                this.$http.post("/pay/product/jsonPro",{}).then(function(res){
					_this.ProList=res.body.res.products;
				});
            },
            //分页查询
			listenDate:function(data){
				$(".loading").show();
				var _this = this;
				var cp_id = this.cp_id;
				var pageSize = 10;
				this.$http.post("/pay/cashier/jsonCas",{"pageNum":data,"pageSize":pageSize,"productId":cp_id}).then(function(res){
					$(".loading").hide();
					if(res.body.code=="D1007"){
					 	alert(res.body.msg);
					 	return false;
					 }
					 if(res.body.code=="D1006"){
					 	alert(res.body.msg);
					 	return false;
					 }
					 _this.payList = res.body.res.cashier.res;
					  ////console.log(_this.payList)
					  _this.pageTotal = res.body.res.cashier.total;
					  if(_this.payList==""){
							$(".table_toggle1").show();
						}else{
							$(".table_toggle1").hide();
						}
                     $(".table_toggle").show();
					if (data<=1) {
						total = Math.ceil(_this.pageTotal/10);
					}
					   _this.all = total;
					   _this.cur = data;
				});
	        },
	        //运行平台
	        ptList:function(){
            	var _this = this;
                this.$http.post("/pay/paymentChannel/jsonPla",{"tab":"2"}).then(function(res){
                	 // //console.log(res)
                	 this.ptList1=res.body.res.platform;
                	 // //console.log(this.ptList1)
				});
            },
            //可选支付通道list
	        kxList:function(msg,list){
            	var _this = this;
            	var msg = this.proName;
            	var list = this.ptName;
                this.$http.post("/pay/cashier/jsonPay",{"productId":msg,"platformId":list}).then(function(res){
                	////console.log(res);
                	this.kxzfList=res.body.res.paymentChannel;
				});
            },
	        kxList_1:function(msg,list){
            	var _this = this;
            	var msg = this.proName_1;
            	var list = this.ptName_1;
                this.$http.post("/pay/cashier/jsonPay",{"productId":msg,"platformId":list}).then(function(res){
                	////console.log(res);
                	this.kxzfList_1=res.body.res.paymentChannel;
				});
            },
            //管理id查询
	        idUp:function(msg){
            	var _this = this;
                this.$http.post("/pay/cashier/oneCas",{"id":msg}).then(function(res){
                	   this.channelId_1=res.body.res.cashier.channelId;
                	   this.ptName_1=res.body.res.cashier.platformId;
                	   this.platformName_1=res.body.res.cashier.platformName;
                	   this.proName_1=res.body.res.cashier.productId;
                	   this.productName_1=res.body.res.cashier.productName;
                	   this.id_1=res.body.res.cashier.id;
                	   var str =  this.channelId_1;
                	   var array = str.split(",");
                	   this.checkedNames_1=array;
				});
            },
            //管理修改
            upAdd:function(msg){
            	var _this = this;
            	var ptName=this.ptName_1;
            	var proName=this.proName_1;
            	var checkedNames = this.checkedNames_1;
            	var platformId = checkedNames.join(",");
                this.$http.post("/pay/cashier/updateCas",{"id":msg,"productId":proName,"platformId":ptName,"channelId":platformId}).then(function(res){
            	    var code=res.body.code;
            	    var msg=res.body.msg;
					if(code=="0000"){
						alert(msg);
						$("#myModal-one").modal("hide");
						_this.listenDate(this.cur);
						_this.ptName="";
						_this.proName="";
						_this.checkedNames=[];
					}else if(code=="0001"){
						alert(msg)
					}
				});
            },
        }
    })
</script>